<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" />

    <!-- Generated with Sphinx 7.2.5 and Furo 2023.08.19 -->
        <title>maize.utilities.chem.chem - maize contrib</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: rgb(0,56,101);
  --color-brand-content: rgb(0,56,101);
  --color-api-name: rgb(60,16,83);
  --color-api-pre-name: rgb(60,16,83);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">maize contrib</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/maize-contrib-logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docking.html">Docking workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docking.html#Adding-a-custom-node">Adding a custom node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docking.html#High-throughput-docking">High-throughput docking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docking.html#Parallel-docking">Parallel docking</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom-nodes.html">Custom nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom-workflows.html">Custom workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../steps/index.html">Steps</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Steps</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../steps/docking.html">Docking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../steps/molecule.html">Molecule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../steps/misc.html">Miscallaneous</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../utilities.html">Utilities</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Utilities</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.html">chem</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of chem</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.html">chem</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of chem</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.convert.html">convert</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.load_sdf_library.html">load_sdf_library</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.mcs.html">mcs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.merge_libraries.html">merge_libraries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.result_check.html">result_check</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.rmsd.html">rmsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.save_sdf_library.html">save_sdf_library</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.save_smiles.html">save_smiles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html">Conformer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html">Isomer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html">IsomerCollection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../_autosummary/maize.utilities.chem.chem.ChemistryException.html">ChemistryException</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://molecularai.github.io/maize/docs/steps">Steps</a></li>
<li class="toctree-l1"><a class="reference external" href="https://molecularai.github.io/maize">Maize</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for maize.utilities.chem.chem</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions and types for chemistry.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stderr</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FrameType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">ParamSpec</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Self</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span><span class="p">,</span> <span class="n">rdBase</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span><span class="p">,</span> <span class="n">rdFMCS</span><span class="p">,</span> <span class="n">rdchem</span><span class="p">,</span> <span class="n">rdGeometry</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.EnumerateStereoisomers</span> <span class="kn">import</span> <span class="n">EnumerateStereoisomers</span><span class="p">,</span> <span class="n">StereoEnumerationOptions</span>

<span class="kn">from</span> <span class="nn">maize.utilities.execution</span> <span class="kn">import</span> <span class="n">CommandRunner</span>
<span class="kn">from</span> <span class="nn">maize.utilities.validation</span> <span class="kn">import</span> <span class="n">FailValidator</span>

<span class="n">rdBase</span><span class="o">.</span><span class="n">WrapLogs</span><span class="p">()</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>

<span class="c1"># This is vital to have all properties transferred properly between processes</span>
<span class="c1"># See also: https://github.com/rdkit/rdkit/issues/1320</span>
<span class="n">Chem</span><span class="o">.</span><span class="n">SetDefaultPickleProperties</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">PropertyPickleOptions</span><span class="o">.</span><span class="n">AllProps</span><span class="p">)</span>

<span class="c1"># Allows partial sanitization of charged molecules with non-standard valences</span>
<span class="n">_SANITIZE_FLAGS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_FINDRADICALS</span>
    <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_KEKULIZE</span>
    <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_SETAROMATICITY</span>
    <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_SETCONJUGATION</span>
    <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_SETHYBRIDIZATION</span>
    <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeFlags</span><span class="o">.</span><span class="n">SANITIZE_SYMMRINGS</span>
<span class="p">)</span>
<span class="n">SCHRODINGER_VARIANT_TAG</span> <span class="o">=</span> <span class="s2">&quot;s_lp_Variant&quot;</span>


<div class="viewcode-block" id="ChemistryException">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.ChemistryException.html#maize.utilities.chem.chem.ChemistryException">[docs]</a>
<span class="k">class</span> <span class="nc">ChemistryException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised for issues with executing RDKit or Openbabel&quot;&quot;&quot;</span></div>



<span class="n">_P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;_P&quot;</span><span class="p">)</span>
<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="result_check">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.result_check.html#maize.utilities.chem.chem.result_check">[docs]</a>
<span class="k">def</span> <span class="nf">result_check</span><span class="p">(</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span> <span class="n">none_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">false_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls an RDKit or Openbabel function and raises an exception if</span>
<span class="sd">    something goes wrong, instead of just returning ``None``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func</span>
<span class="sd">        The function to wrap</span>
<span class="sd">    none_check</span>
<span class="sd">        Whether to check for a ``None`` return value</span>
<span class="sd">    false_check</span>
<span class="sd">        Whether to check for a ``False`` return value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Callable[_P, _T]</span>
<span class="sd">        The wrapped function</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># RDKit does not throw exceptions, but just returns `None`</span>
    <span class="c1"># if something went wrong. It also writes the cause to its</span>
    <span class="c1"># internal logger, so we need to redirect this output to</span>
    <span class="c1"># stderr (with the call to `WrapLogs()` above) and then</span>
    <span class="c1"># capture it to get useful information. The same goes for</span>
    <span class="c1"># Openbabel, except that it returns ``False`` on failure.</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">none_check</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">false_check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">res</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Failed&quot;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> raised the following error: </span><span class="si">{</span><span class="n">logger</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">wrapped</span></div>



<span class="k">def</span> <span class="nf">_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a wrapped function to timeout by raising a `TimeoutError`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timeout</span>
<span class="sd">        Timeout in seconds, has to be an integer value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Callable[[Callable[_P, _T]], Callable[_P, _T]]</span>
<span class="sd">        Wrapped function</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TimeoutError</span>
<span class="sd">        If the wrapped function times out</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Function timed out&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">_handler</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inner</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<div class="viewcode-block" id="convert">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.convert.html#maize.utilities.chem.chem.convert">[docs]</a>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert one or more molecule files into another using openbabel.</span>
<span class="sd">    Will detect the input and output formats from the suffixes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file</span>
<span class="sd">        Input file(s) to convert, if multiple are given will</span>
<span class="sd">        attempt to aggregate output into a single file</span>
<span class="sd">    output</span>
<span class="sd">        Output file path</span>
<span class="sd">    extra</span>
<span class="sd">        Additional arguments to pass to ``obabel``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>

    <span class="n">inp_format</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">out_format</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File at &#39;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>

    <span class="n">all_files</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;obabel </span><span class="si">{</span><span class="n">all_files</span><span class="si">}</span><span class="s2"> -i</span><span class="si">{</span><span class="n">inp_format</span><span class="si">}</span><span class="s2"> -o</span><span class="si">{</span><span class="n">out_format</span><span class="si">}</span><span class="s2"> -O </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="n">extra</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">arg</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">CommandRunner</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">FailValidator</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)])</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">run_validate</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_sdf_library">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.save_sdf_library.html#maize.utilities.chem.chem.save_sdf_library">[docs]</a>
<span class="k">def</span> <span class="nf">save_sdf_library</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">mols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">],</span>
    <span class="n">conformers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">split_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;schrodinger&quot;</span><span class="p">,</span> <span class="s2">&quot;inchi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inchi&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves a list of IsomerCollection instances to an SDF file.</span>
<span class="sd">    Will only write one Isomer and one conformer for each molecule.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file</span>
<span class="sd">        Path to the output SDF file</span>
<span class="sd">    smiles</span>
<span class="sd">        List of `IsomerCollection` to write</span>
<span class="sd">    conformers</span>
<span class="sd">        Whether to write all conformers</span>
<span class="sd">    split_strategy</span>
<span class="sd">        How to determine which isomer belongs to which molecule, from special tags or</span>
<span class="sd">        the name. ``schrodinger`` expects a name like ``1:0`` (molecule:isomer), ``inchi``</span>
<span class="sd">        expects an InChI key as a name, which can be split into molecule and isomer.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDWriter</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">molecules</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;schrodinger&quot;</span><span class="p">:</span>
                    <span class="n">iso</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;inchi&quot;</span><span class="p">:</span>
                    <span class="n">iso</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">inchi</span>

                <span class="k">if</span> <span class="n">conformers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">n_conformers</span><span class="p">):</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">confId</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_sdf_library">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.load_sdf_library.html#maize.utilities.chem.chem.load_sdf_library">[docs]</a>
<span class="k">def</span> <span class="nf">load_sdf_library</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">split_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;schrodinger&quot;</span><span class="p">,</span> <span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="s2">&quot;schrodinger-tag&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inchi&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads an SDF library containing multiple molecules with potentially</span>
<span class="sd">    multiple isomers each, and creates an `IsomerCollection` for all of them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file</span>
<span class="sd">        Path to the SDF file</span>
<span class="sd">    split_strategy</span>
<span class="sd">        How to determine which isomer belongs to which molecule, from special tags or</span>
<span class="sd">        the name. ``schrodinger`` expects a name like ``1:0`` (molecule:isomer),</span>
<span class="sd">        ``schrodinger-tag`` expects a tag named ``s_lp_Variant``, ``inchi`` expects an</span>
<span class="sd">        InChI key as a name, which can be split into molecule and isomer, and ``&#39;none&#39;``</span>
<span class="sd">        provides a separate `IsomerCollection` for each entry.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[IsomerCollection]</span>
<span class="sd">        Created molecules</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mols</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">supp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">supp</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">iso</span> <span class="o">=</span> <span class="n">Isomer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

            <span class="n">mol_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>
            <span class="c1"># Split based on special name: molecule:isomer</span>
            <span class="k">if</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;schrodinger&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iso</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span> <span class="o">:=</span> <span class="n">iso</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Parsed molecule </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> does not have a suitable name,&quot;</span>
                        <span class="s2">&quot;expected format molecule-index:isomer-index&quot;</span>
                    <span class="p">)</span>
                <span class="n">mol_idx</span><span class="p">,</span> <span class="n">iso_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span>
                <span class="n">mols</span><span class="p">[</span><span class="n">mol_idx</span><span class="p">][</span><span class="n">iso_idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

            <span class="c1"># Split based on special tag created by Schrodinger</span>
            <span class="k">elif</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;schrodinger-tag&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iso</span><span class="o">.</span><span class="n">has_tag</span><span class="p">(</span><span class="n">SCHRODINGER_VARIANT_TAG</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Parsed molecule does not have the expected &#39;</span><span class="si">{</span><span class="n">SCHRODINGER_VARIANT_TAG</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># The tag will be something like &#39;file.smi:1-1&#39; with the indices</span>
                <span class="c1"># representing molecule and isomer number, respectively</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">get_tag</span><span class="p">(</span><span class="n">SCHRODINGER_VARIANT_TAG</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">mol_idx</span><span class="p">,</span> <span class="n">iso_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mol_idx</span><span class="p">,</span> <span class="n">iso_nr</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="n">iso_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iso_nr</span><span class="p">)</span>
                <span class="n">mols</span><span class="p">[</span><span class="n">mol_idx</span><span class="p">][</span><span class="n">iso_idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

            <span class="c1"># Split based on InChI key: moleculeinchi-isomerinchi (e.g. ABCDEF-GHIJKL-M)</span>
            <span class="k">elif</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;inchi&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iso</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">inchi_parts</span> <span class="o">:=</span> <span class="n">iso</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Name of parsed molecule (&#39;</span><span class="si">{</span><span class="n">iso</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;) is not a valid InChI key&quot;</span>
                    <span class="p">)</span>
                <span class="n">mol_part</span><span class="p">,</span> <span class="o">*</span><span class="n">iso_part</span> <span class="o">=</span> <span class="n">inchi_parts</span>
                <span class="n">mols</span><span class="p">[</span><span class="n">mol_part</span><span class="p">][</span><span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iso_part</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

            <span class="c1"># No split, each entry is a separate molecule</span>
            <span class="k">elif</span> <span class="n">split_strategy</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">mols</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">IsomerCollection</span><span class="p">([</span><span class="n">Isomer</span><span class="o">.</span><span class="n">from_rdmols</span><span class="p">(</span><span class="n">isos</span><span class="p">)</span> <span class="k">for</span> <span class="n">isos</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mols</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_lib2dict</span><span class="p">(</span><span class="n">lib</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a nested dictionary from a library using InChI keys&quot;&quot;&quot;</span>
    <span class="n">dic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">lib</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">mol_id</span><span class="p">,</span> <span class="n">iso_id</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="n">mol_id</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iso</span>
    <span class="k">return</span> <span class="n">dic</span>


<span class="k">def</span> <span class="nf">_dict2lib</span><span class="p">(</span><span class="n">dic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a list of `IsomerCollection` from a nested dictionary&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">IsomerCollection</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">isodict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">for</span> <span class="n">isodict</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>


<div class="viewcode-block" id="merge_libraries">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.merge_libraries.html#maize.utilities.chem.chem.merge_libraries">[docs]</a>
<span class="k">def</span> <span class="nf">merge_libraries</span><span class="p">(</span>
    <span class="n">base</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;IsomerCollection&quot;</span><span class="p">]:</span>
    <span class="n">base_dic</span><span class="p">,</span> <span class="n">other_dic</span> <span class="o">=</span> <span class="n">_lib2dict</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">_lib2dict</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">iso_dic</span> <span class="ow">in</span> <span class="n">base_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other_dic</span><span class="p">:</span>
            <span class="n">iso_dic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_dic</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_dict2lib</span><span class="p">(</span><span class="n">base_dic</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_smiles">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.save_smiles.html#maize.utilities.chem.chem.save_smiles">[docs]</a>
<span class="k">def</span> <span class="nf">save_smiles</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves a list of SMILES to a ``.smi`` file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file</span>
<span class="sd">        Path to the output file</span>
<span class="sd">    smiles</span>
<span class="sd">        List of SMILES codes to write</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.smi&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File needs to have the .smi suffix&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span></div>



<div class="viewcode-block" id="mcs">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.mcs.html#maize.utilities.chem.chem.mcs">[docs]</a>
<span class="k">def</span> <span class="nf">mcs</span><span class="p">(</span><span class="o">*</span><span class="n">mols</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the maximum common substructure (MCS) between multiple molecules.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mols</span>
<span class="sd">        Reference `Isomer` molecules</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Isomer</span>
<span class="sd">        Isomer instance using the MCS</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mcs</span> <span class="o">=</span> <span class="n">rdFMCS</span><span class="o">.</span><span class="n">FindMCS</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">_molecule</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Isomer</span><span class="p">(</span><span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">)(</span><span class="n">mcs</span><span class="o">.</span><span class="n">smartsString</span><span class="p">))</span></div>



<div class="viewcode-block" id="rmsd">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.rmsd.html#maize.utilities.chem.chem.rmsd">[docs]</a>
<span class="k">def</span> <span class="nf">rmsd</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the unaligned root-mean-square deviation between</span>
<span class="sd">    all conformers of an isomer and a reference molecule.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mol</span>
<span class="sd">        Molecule in the form of an `Isomer`</span>
<span class="sd">    ref</span>
<span class="sd">        Reference molecule</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray[np.float32]</span>
<span class="sd">        RMSDs for all conformers</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inds_ref</span><span class="p">,</span> <span class="n">inds_mol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atommap</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">inds_mol</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">inds_ref</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">diff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span></div>



<span class="n">_TAG_METHODS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">bool</span><span class="p">:</span> <span class="s2">&quot;SetBoolProp&quot;</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">:</span> <span class="s2">&quot;SetIntProp&quot;</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">:</span> <span class="s2">&quot;SetDoubleProp&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">_ValidRDKitTagType</span> <span class="o">=</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_prop_setter</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Conformer</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span> <span class="o">|</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Atom</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets RDKit properties using the appropriate setter.&quot;&quot;&quot;</span>

    <span class="c1"># Arrays require a conversion to a string; numpy arrays and</span>
    <span class="c1"># lists serialize differently (with and without commas as</span>
    <span class="c1"># delimiters), so we convert to list by default</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># Numpy floats and ints need special treatment</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Should just be a string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># `SetProp` is the default for all strings</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_TAG_METHODS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s2">&quot;SetProp&quot;</span><span class="p">))(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_prop_converter</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ValidRDKitTagType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert raw RDKit tags to an appropriate python type&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">raw</span>

    <span class="c1"># This should never happen</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got invalid type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; for value &#39;</span><span class="si">{</span><span class="n">raw</span><span class="si">}</span><span class="s2">&#39; from rdkit tag&quot;</span><span class="p">)</span>

    <span class="c1"># We have an array and attempt to deserialize to an ndarray of floats</span>
    <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">raw</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw</span>


<div class="viewcode-block" id="Conformer">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer">[docs]</a>
<span class="k">class</span> <span class="nc">Conformer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin shim layer for rdkit conformers. Each conformer will have an `Isomer` as its parent.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rd_conf</span>
<span class="sd">        RDKit conformer object</span>
<span class="sd">    parent</span>
<span class="sd">        `Isomer` parent instance</span>
<span class="sd">    _rd_parent</span>
<span class="sd">        The actual rdkit molecule parent of the conformer</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Conformer.__init__">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rd_conf</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Conformer</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">,</span>
        <span class="n">_rd_parent</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">rdchem</span><span class="o">.</span><span class="n">Conformer</span><span class="p">(</span><span class="n">rd_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># We need this to ensure the parent rdkit molecule instance does not go out of scope,</span>
        <span class="c1"># as this means we would lose access to our conformer (conformers cannot exist alone</span>
        <span class="c1"># and always need a parent molecule instance to exist). See this related issue for a</span>
        <span class="c1"># (now fixed) example: https://github.com/rdkit/rdkit/issues/3492</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rd_parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_molecule</span> <span class="k">if</span> <span class="n">_rd_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_rd_parent</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(n_atoms=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;orphan=</span><span class="si">{</span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">HasOwningMol</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Conformer.from_rdmol">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.from_rdmol">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_rdmol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">,</span> <span class="n">renumber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a conformer from an RDKit molecule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rd_mol</span>
<span class="sd">            RDKit molecule instance</span>
<span class="sd">        parent</span>
<span class="sd">            Parent `Isomer` instance</span>
<span class="sd">        renumber</span>
<span class="sd">            Ensure atom numbers of the molecule match the parent</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_atoms_conf</span> <span class="o">:=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())</span> <span class="o">!=</span> <span class="n">parent</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Atom number mismatch, parent molecule has </span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">n_atoms</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;conformer has </span><span class="si">{</span><span class="n">n_atoms_conf</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># We can&#39;t fully sanitize as we might have charged molecules</span>
        <span class="c1"># (for example with N valence of 4), so we disable sanitization</span>
        <span class="c1"># at load time and do a partial sanitizing step after, see also:</span>
        <span class="c1"># https://www.rdkit.org/docs/Cookbook.html#explicit-valence-error-partial-sanitization</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeMol</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">_SANITIZE_FLAGS</span><span class="p">,</span> <span class="n">catchErrors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># We ensure that the atom numbering is consistent between the new conformer and the parent,</span>
        <span class="c1"># as the passed in molecule might not have any relation to the parent. This can be important</span>
        <span class="c1"># when converting from files that treat protonations differently, for example PDBQT.</span>
        <span class="c1"># Based on: https://www.rdkit.org/docs/Cookbook.html#reorder-atoms</span>
        <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
            <span class="n">parent_canon_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">CanonicalRankAtoms</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_molecule</span><span class="p">))</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">newmol_canon_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">CanonicalRankAtoms</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">))</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>
            <span class="n">inds</span><span class="p">[</span><span class="n">parent_canon_order</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmol_canon_order</span>

            <span class="c1"># FIXME This fails occasionally, example:</span>
            <span class="c1"># C1[C@H]2[C@@H]([C@@H](S1)CCCCC(=O)O)NC(=S)N2</span>
            <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RenumberAtoms</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">])</span>

        <span class="n">rd_conf</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rd_conf</span><span class="o">=</span><span class="n">rd_conf</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">_rd_parent</span><span class="o">=</span><span class="n">rd_mol</span><span class="p">)</span>

        <span class="c1"># Properties are not automatically copied over to the conformer</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conf</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">)())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all tags&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordinates of the conformer&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">HasOwningMol</span><span class="p">():</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span>

    <span class="nd">@coordinates</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the coordinates&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">HasOwningMol</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_conf_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="c1"># RDKit conformers are intrinsically tied to their parent molecule instance.</span>
    <span class="c1"># Therefore, calling `RemoveConformer` on the parent will partially deallocate</span>
    <span class="c1"># the memory associated with the conformer, leaving an orphan instance with no</span>
    <span class="c1"># atoms or coordinates. We thus need to internally keep track of the coordinates</span>
    <span class="c1"># and regenerate the Conformer wrapper manually when assigning an existing</span>
    <span class="c1"># conformer to an RDKit molecule, regardless of if it&#39;s been orphaned or not.</span>
    <span class="c1"># See this classic RDKit bug: https://github.com/rdkit/rdkit/issues/3817</span>
<div class="viewcode-block" id="Conformer.regenerate">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.regenerate">[docs]</a>
    <span class="k">def</span> <span class="nf">regenerate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recreate the internal RDKit conformer object to avoid deallocation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_conf_coords</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">)</span></div>


<div class="viewcode-block" id="Conformer.set_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.set_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a tag / property for the whole isomer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            Tag to set</span>
<span class="sd">        value</span>
<span class="sd">            Corresponding value for all conformers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">HasOwningMol</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Conformer is orphaned and will not remember any set tags&quot;</span><span class="p">)</span>
        <span class="n">_prop_setter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Conformer.get_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.get_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ValidRDKitTagType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value for the specified tag.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>
<span class="sd">        default</span>
<span class="sd">            A default value to return if the key is not found</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            The value of the tag</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If the specified tag couldn&#39;t be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; not found in molecule&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">_prop_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span></div>


<div class="viewcode-block" id="Conformer.has_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Conformer.html#maize.utilities.chem.chem.Conformer.has_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">has_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether the specified tag is set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether the tag is defined</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">HasProp</span><span class="p">)(</span><span class="n">tag</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_set_conf_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the coordinates of the wrapped RDKit conformer&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rdGeometry</span><span class="o">.</span><span class="n">Point3D</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span></div>



<div class="viewcode-block" id="Isomer">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer">[docs]</a>
<span class="k">class</span> <span class="nc">Isomer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin shim layer for rdkit molecules. Here, an isomer refers</span>
<span class="sd">    to a unique chemical form of a molecule, i.e. a form separated</span>
<span class="sd">    by major energy barriers. Note that SMILES codes do not</span>
<span class="sd">    necessarily map to a single isomer! Some examples of unique isomers:</span>

<span class="sd">    * A ring conformer (e.g. for cyclohexane)</span>
<span class="sd">    * Cis-trans isomers</span>
<span class="sd">    * Chirality</span>
<span class="sd">    * Tautomers</span>
<span class="sd">    * Different protonation states</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rd_mol</span>
<span class="sd">        RDKit molecule instance</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Isomer.__init__">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">rd_mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_conformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_tag</span> <span class="o">=</span> <span class="s2">&quot;score&quot;</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, scores=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scored</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(n_atoms=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;n_conformers=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_conformers</span><span class="si">}</span><span class="s2">, charge=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="si">}{</span><span class="n">scores</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># RDKit is for some reason unable to pickle conformer objects directly,</span>
    <span class="c1"># but only as part of an rdmol object. Because `Isomer` keeps references</span>
    <span class="c1"># to our Conformer wrapper objects, which in turn have a reference to the</span>
    <span class="c1"># RDKit conformer, pickling will fail. We therefore remove our conformer</span>
    <span class="c1"># proxies before pickling and restore them later with `_init_conformers()`.</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_conformers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;_conformers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">inst</span>

<div class="viewcode-block" id="Isomer.from_rdmols">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.from_rdmols">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_rdmols</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rd_mols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span> <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a molecule from multiple RDKit molecules acting as conformers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rd_mols</span>
<span class="sd">            List of RDKit molecule instances</span>
<span class="sd">        sanitize</span>
<span class="sd">            Whether to sanitize the molecule</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            Molecule instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">rd_mols</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">iso</span><span class="o">.</span><span class="n">add_conformer</span><span class="p">(</span><span class="n">Conformer</span><span class="o">.</span><span class="n">from_rdmol</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">iso</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">iso</span></div>


<div class="viewcode-block" id="Isomer.from_smiles">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.from_smiles">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_smiles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a molecule from a SMILES string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        smiles</span>
<span class="sd">            The SMILES string to initialize the molecule with</span>
<span class="sd">        sanitize</span>
<span class="sd">            Whether to sanitize the molecule</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            Molecule instance</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SMILES code</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">)(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">=</span><span class="n">rd_mol</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.from_sdf">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.from_sdf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sdf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">read_conformers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a molecule from an SDF file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file</span>
<span class="sd">            The SDF file to initialize the molecule with</span>
<span class="sd">        read_conformers</span>
<span class="sd">            Whether to read all conformers</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            Molecule instance</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SDF</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rd_mols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span> <span class="k">as</span> <span class="n">suppl</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rd_mol</span> <span class="ow">in</span> <span class="n">suppl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rd_mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">read_conformers</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
                <span class="n">rd_mols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rd_mols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SDF file &#39;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; produced an empty molecule&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_rdmols</span><span class="p">(</span><span class="n">rd_mols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.from_sdf_block">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.from_sdf_block">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sdf_block</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sdf</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a molecule from an SDF string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sdf</span>
<span class="sd">            The SDF string to initialize the molecule with</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            Molecule instance</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SDF</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">)(</span><span class="n">sdf</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">=</span><span class="n">rd_mol</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the molecule name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;_Name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inchi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the InChI key for the molecule&quot;&quot;&quot;</span>
        <span class="c1"># We need the fixed-H option here to ensure unique InChIs for different</span>
        <span class="c1"># protonation states, see: https://www.inchi-trust.org/technical-faq-2/#15.24</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToInchiKey</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="s2">&quot;-FixedH&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of atoms in the molecule&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of conformers in the molecule&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The charge of the molecule&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The scores of the molecule&quot;&quot;&quot;</span>
        <span class="n">conf_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">get_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_tag</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformers</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">iso_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_tag</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">conf_scores</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf_scores</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso_scores</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">conf_scores</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">iso_scores</span>
        <span class="k">return</span> <span class="n">conf_scores</span>

    <span class="nd">@scores</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the scores&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_tag</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conf</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score_tag</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scored</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the molecule was scored&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Conformer</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all stored isomer conformers in an iterable structure&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conformers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get coordinates of all stored conformers as one NDArray&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">conf</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformers</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all tags&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">())</span>

<div class="viewcode-block" id="Isomer.to_sdf">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.to_sdf">[docs]</a>
    <span class="k">def</span> <span class="nf">to_sdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">write_conformers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an SDF file for the isomer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">            Output file path</span>
<span class="sd">        write_conformers</span>
<span class="sd">            Whether to write all conformers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDWriter</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">write_conformers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetConformers</span><span class="p">():</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">confId</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.to_smiles">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.to_smiles">[docs]</a>
    <span class="k">def</span> <span class="nf">to_smiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a SMILES code for the isomer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">))</span></div>


<div class="viewcode-block" id="Isomer.to_mol_block">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.to_mol_block">[docs]</a>
    <span class="k">def</span> <span class="nf">to_mol_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a MOL block for the isomer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToMolBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">))</span></div>


<div class="viewcode-block" id="Isomer.addh">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.addh">[docs]</a>
    <span class="k">def</span> <span class="nf">addh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds hydrogens to the molecule&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.set_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.set_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a tag / property for the whole isomer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            Tag to set</span>
<span class="sd">        value</span>
<span class="sd">            Corresponding value for all conformers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_prop_setter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.get_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.get_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ValidRDKitTagType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value for the specified tag.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>
<span class="sd">        default</span>
<span class="sd">            A default value to return if the key is not found</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            The value of the tag</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If the specified tag couldn&#39;t be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; not found in molecule&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">_prop_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span></div>


<div class="viewcode-block" id="Isomer.has_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.has_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">has_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether the specified tag is set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether the tag is defined</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">HasProp</span><span class="p">)(</span><span class="n">tag</span><span class="p">))</span></div>


<div class="viewcode-block" id="Isomer.set_atomic_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.set_atomic_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">set_atomic_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_ValidRDKitTagType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a tag / property for a single atom.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx</span>
<span class="sd">            Index of the atom</span>
<span class="sd">        tag</span>
<span class="sd">            Tag to set</span>
<span class="sd">        value</span>
<span class="sd">            Corresponding value for the atom</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">)(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">_prop_setter</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.get_atomic_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.get_atomic_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">get_atomic_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value for the specified tag of an atom.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx</span>
<span class="sd">            Index of the atom</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>
<span class="sd">        default</span>
<span class="sd">            A default value to return if the key is not found</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            The value of the tag</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If the specified tag couldn&#39;t be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">)(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; not found in atom </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.has_atomic_tag">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.has_atomic_tag">[docs]</a>
    <span class="k">def</span> <span class="nf">has_atomic_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether the specified atomic tag is set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx</span>
<span class="sd">            Index of the atom</span>
<span class="sd">        tag</span>
<span class="sd">            The tag to lookup</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether the tag is defined</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">)(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_check</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">)(</span><span class="n">tag</span><span class="p">))</span></div>


<div class="viewcode-block" id="Isomer.add_conformer">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.add_conformer">[docs]</a>
    <span class="k">def</span> <span class="nf">add_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Conformer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a conformer to the isomer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        conf</span>
<span class="sd">            Conformer instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">regenerate</span><span class="p">()</span>
        <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">,</span> <span class="n">none_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">conf</span><span class="o">.</span><span class="n">_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.remove_conformer">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.remove_conformer">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a conformer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx</span>
<span class="sd">            Index of the conformer to be removed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">RemoveConformer</span><span class="p">,</span> <span class="n">none_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conformers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.clear_conformers">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.clear_conformers">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all conformers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">RemoveAllConformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conformers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Conformer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Isomer.update_conformers_from_mol_block">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.update_conformers_from_mol_block">[docs]</a>
    <span class="k">def</span> <span class="nf">update_conformers_from_mol_block</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">score_parser</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update molecule conformers from a mol block.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol</span>
<span class="sd">            The mol block</span>
<span class="sd">        score_parser</span>
<span class="sd">            Function used to parse a score from the mol properties</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the mol block</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_conformers</span><span class="p">()</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">)(</span><span class="n">block</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">Conformer</span><span class="o">.</span><span class="n">from_rdmol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_conformer</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span><span class="s2">&quot;Unable to parse conformer, error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

        <span class="c1"># Only set scores if we actually got some, otherwise they might be set externally</span>
        <span class="k">if</span> <span class="n">score_parser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score_parser</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Isomer.update_conformers_from_sdf">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.update_conformers_from_sdf">[docs]</a>
    <span class="k">def</span> <span class="nf">update_conformers_from_sdf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sdf</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">score_parser</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update molecule conformers from an SDF file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sdf</span>
<span class="sd">            The SDF file to initialize the molecule with</span>
<span class="sd">        score_parser</span>
<span class="sd">            Function used to parse a score from the SDF properties</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SDF</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_conformers</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">sdf</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">supp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">supp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conf</span> <span class="o">=</span> <span class="n">Conformer</span><span class="o">.</span><span class="n">from_rdmol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_conformer</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to parse conformer, error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">score_parser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">score_parser</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">())</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># Only set scores if we actually got some, otherwise they might be set externally</span>
        <span class="k">if</span> <span class="n">score_parser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.atommap">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.atommap">[docs]</a>
    <span class="k">def</span> <span class="nf">atommap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="s2">&quot;Isomer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the atom index mappings based on the MCS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol</span>
<span class="sd">            Reference `Isomer`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[tuple[int, int]]</span>
<span class="sd">            Pairs of atom indices</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mcs_mol</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
        <span class="n">ref_substructure</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">)(</span><span class="n">mcs_mol</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span>
        <span class="n">iso_substructure</span> <span class="o">=</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">)(</span><span class="n">mcs_mol</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ref_substructure</span><span class="p">,</span> <span class="n">iso_substructure</span><span class="p">))</span></div>


<div class="viewcode-block" id="Isomer.generate_stereoisomers">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.generate_stereoisomers">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_stereoisomers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates possible enantiomers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_max</span>
<span class="sd">            Maximum number of stereoisomers to generate</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Molecule]</span>
<span class="sd">            List of new molecules representing distinct stereoisomers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_max</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="n">enum_options</span> <span class="o">=</span> <span class="n">StereoEnumerationOptions</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxIsomers</span><span class="o">=</span><span class="n">n_max</span><span class="p">,</span> <span class="n">tryEmbedding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">isomer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="n">EnumerateStereoisomers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">enum_options</span><span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="Isomer.to_pdb">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.to_pdb">[docs]</a>
    <span class="k">def</span> <span class="nf">to_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a molecule to a PDB file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">            Path to the PDB file to write</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_check</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToPDBFile</span><span class="p">,</span> <span class="n">none_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChemistryException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File at &#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; was not written&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Isomer.embed">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.Isomer.html#maize.utilities.chem.chem.Isomer.embed">[docs]</a>
    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_conformers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a 3D embedding of the molecule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_conformers</span>
<span class="sd">            Number of conformers to generate</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error generating the embeddings</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_conformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addh</span><span class="p">()</span>
        <span class="n">result_check</span><span class="p">(</span><span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMultipleConfs</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span> <span class="n">numConfs</span><span class="o">=</span><span class="n">n_conformers</span><span class="p">,</span> <span class="n">maxAttempts</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_conformers</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_init_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes `Conformer` instances based on contained RDKit conformers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conformers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Conformer</span><span class="p">(</span><span class="n">rd_conf</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rd_conf</span> <span class="ow">in</span> <span class="n">result_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">GetConformers</span><span class="p">)()</span>
        <span class="p">]</span></div>



<div class="viewcode-block" id="IsomerCollection">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection">[docs]</a>
<span class="k">class</span> <span class="nc">IsomerCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a collection of isomers / enumerations of a molecule.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    molecules</span>
<span class="sd">        Molecules part of the collection and sharing a common topology</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="IsomerCollection.__init__">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecules</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Isomer</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">molecules</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, best_score=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="si">:</span><span class="s2">4.4</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scored</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">n_isomers=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_isomers</span><span class="si">}{</span><span class="n">scores</span><span class="si">}</span><span class="s2">)&quot;</span>

<div class="viewcode-block" id="IsomerCollection.from_smiles">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.from_smiles">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_smiles</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_isomers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an isomer collection from a SMILES string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        smiles</span>
<span class="sd">            The SMILES string to initialize the collection with</span>
<span class="sd">        max_isomers</span>
<span class="sd">            Maximum number of isomers to generate</span>
<span class="sd">        sanitize</span>
<span class="sd">            Whether to sanitize the molecule</span>
<span class="sd">        timeout</span>
<span class="sd">            Timeout in seconds before failing stereoisomer generation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IsomerCollection</span>
<span class="sd">            IsomerCollection instance</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SMILES code</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        steps.mai.molecule.Gypsum</span>
<span class="sd">            A more advanced approach of generating any</span>
<span class="sd">            kind of isomer or high-energy conformers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">Isomer</span><span class="o">.</span><span class="n">from_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isomers</span> <span class="o">=</span> <span class="n">_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)(</span><span class="n">mol</span><span class="o">.</span><span class="n">generate_stereoisomers</span><span class="p">)(</span><span class="n">n_max</span><span class="o">=</span><span class="n">max_isomers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stereoisomer generation for </span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2"> (SMILES=</span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">) timed out&quot;</span><span class="p">)</span>
            <span class="n">isomers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">isomers</span><span class="p">)</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="k">return</span> <span class="n">collection</span></div>


<div class="viewcode-block" id="IsomerCollection.from_sdf">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.from_sdf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sdf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an isomer collection from an SDF file</span>
<span class="sd">        containing different isomers or conformers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file</span>
<span class="sd">            The SDF file input</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IsomerCollection</span>
<span class="sd">            IsomerCollection instance</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error parsing the SMILES code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">supp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">supp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">mols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Isomer</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s2">&quot;SMILES&quot;</span><span class="p">):</span>
                    <span class="n">smiles</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s2">&quot;SMILES&quot;</span><span class="p">)</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coll</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="k">return</span> <span class="n">coll</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_isomers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of contained isomers&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scored</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the isomers have been scored&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">scored</span> <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The best score among all isomers / conformers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scored</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isomers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nd">@best_score</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">best_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inchi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the InChI key for the molecule&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isomers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inchi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="IsomerCollection.to_sdf">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.to_sdf">[docs]</a>
    <span class="k">def</span> <span class="nf">to_sdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write all isomers to an SDF file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">            Output file path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDWriter</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iso</span><span class="o">.</span><span class="n">_molecule</span><span class="p">)</span></div>

<div class="viewcode-block" id="IsomerCollection.to_smiles">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.to_smiles">[docs]</a>
    <span class="k">def</span> <span class="nf">to_smiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return smiles for an isomer collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">iso</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">]</span></div>


<div class="viewcode-block" id="IsomerCollection.embed">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.embed">[docs]</a>
    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_conformers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a 3D embedding of all isomers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_conformers</span>
<span class="sd">            Number of conformers to generate</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ChemistryException</span>
<span class="sd">            If there was an error generating the embeddings</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">n_conformers</span><span class="p">)</span></div>


<div class="viewcode-block" id="IsomerCollection.remove_isomer">
<a class="viewcode-back" href="../../../../_autosummary/maize.utilities.chem.chem.IsomerCollection.html#maize.utilities.chem.chem.IsomerCollection.remove_isomer">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_isomer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isomer</span><span class="p">:</span> <span class="n">Isomer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove isomer from collection&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">isomer</span><span class="p">)</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Molecular AI Group
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../../_static/documentation_options.js?v=a47416a6"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>